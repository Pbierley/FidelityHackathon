<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>An Investor (AI) — Ask AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0e1116; --panel:#12161d; --card:#0f141a; --border:#1d2a36; --text:#e6f0f2; --muted:#b8c7cc; --brand:#00b3b3; --brand-3:#3da8f5; --radius:14px; --shadow:0 10px 30px rgba(0,0,0,.45); }
    body { margin:0; font-family:Inter,system-ui; background:radial-gradient(1200px 600px at 10% -10%, rgba(61,168,245,.08), transparent), radial-gradient(800px 500px at 90% 10%, rgba(0,179,179,.08), transparent), var(--bg); color:var(--text); }
    .wrap { max-width: 1000px; margin: 28px auto; padding: 0 18px 80px; }
    .hdr { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
    .hdr h1 { margin:0; font-size:28px; }
    .chat { background:var(--panel); border:1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); padding:14px; min-height: 60vh; display:flex; flex-direction:column; gap:12px; }
    .msg { max-width: 80%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); white-space: pre-wrap; line-height: 1.6; }
    .msg p { margin: 0 0 10px 0; }
    .msg p:last-child { margin-bottom: 0; }
    .msg code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; font-family: 'Courier New', monospace; }
    .msg pre { background: rgba(0,0,0,0.4); padding: 10px; border-radius: 6px; overflow-x: auto; }
    .msg ul, .msg ol { margin: 8px 0; padding-left: 20px; }
    .msg strong { font-weight: 700; }
    .me { align-self:flex-end; background:#0b1117; }
    .ai { align-self:flex-start; background:#10161d; }
    .inputbar { margin-top:12px; display:flex; gap:10px; }
    .inputbar input { flex:1; background:var(--card); border:1px solid var(--border); color:var(--text); border-radius:12px; padding:12px; outline:none; }
    .btn { background:linear-gradient(135deg, var(--brand), var(--brand-3)); color:#04222a; border:0; padding:12px 16px; border-radius:12px; font-weight:700; cursor:pointer; }
    .muted { color: var(--muted); font-size:12px; }
    .thinking { opacity: 0.8; font-style: italic; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="hdr">
      <h1>Ask <span style="color:var(--brand)">An Investor</span></h1>
      <a href="index.html#top" class="btn">← Back</a>
    </div>

    <div id="chat" class="chat" aria-live="polite">
      <div class="msg ai">Hi! Ask about options basics, risk, strikes, and more. I'm educational, not advice.</div>
    </div>

    <form id="askForm" class="inputbar">
      <input id="q" placeholder="Ask a question…" autocomplete="off" />
      <button class="btn">Send</button>
    </form>
    <div class="muted">Disclaimer: Educational content only. Not financial advice.</div>
  </div>

<script type="module">
(function () {
  // --- 1) Require login ---
  const loggedIn = document.cookie.split('; ').some(function(c){ return c.indexOf('username=') === 0; });
  if (!loggedIn) {
    const url = new URL('LoginAuth.html', location.href);
    url.searchParams.set('redirect', 'AskAI.html');
    location.replace(url.toString());
    return;
  }

  // --- 2) Decide API base: proxy (/api) or direct (:4000) ---
  var DEFAULT_BACKEND = 'http://localhost:4000';
  var isLocalDev = location.hostname === 'localhost' || location.hostname === '127.0.0.1';
  var BACKEND = isLocalDev
    ? DEFAULT_BACKEND
    : ((import.meta.env && (import.meta.env.VITE_RENDER_URL || import.meta.env.VITE_BACKEND_URL)) || window.__BACKEND_URL || DEFAULT_BACKEND);
  var API_BASE = BACKEND ? (BACKEND + '/api/ai') : '/api/ai';

  // --- 3) Format AI response with proper line breaks and HTML ---
  function formatAIResponse(text) {
    // Escape HTML to prevent XSS
    var escaped = text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#039;');
    
    // Convert markdown-style formatting
    escaped = escaped
      // Convert **bold** to <strong>
      .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
      // Convert `code` to <code>
      .replace(/`([^`]+)`/g, '<code>$1</code>')
      // Convert newlines to <br>
      .replace(/\n/g, '<br>');
    
    return escaped;
  }

  // --- 4) Chat UI helpers ---
  var chat = document.getElementById('chat');
  var form = document.getElementById('askForm');
  var q = document.getElementById('q');

  function bubble(text, who) {
    if (who === void 0) who = 'ai';
    var div = document.createElement('div');
    div.className = 'msg ' + who;
    
    // Format AI responses, use plain text for user messages
    if (who === 'ai') {
      div.innerHTML = formatAIResponse(text);
    } else {
      div.textContent = text;
    }
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
    return div;
  }

  function showThinking() {
    var el = bubble('Thinking', 'ai');
    el.classList.add('thinking');
    var i = 0;
    var id = setInterval(function(){
      i = (i + 1) % 3;
      el.textContent = 'Thinking' + '.'.repeat(i + 1);
    }, 350);
    return { el: el, stop: function(){ clearInterval(id); } };
  }

  // --- 5) Submit handler ---
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    var question = (q.value || '').trim();
    if (!question) return;

    bubble(question, 'me');
    q.value = '';

    var thinking = showThinking();

    try {
      var r = await fetch(API_BASE + '/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ question: question, maxTokens: 300 })
      });

      thinking.stop();
      thinking.el.remove();

      if (!r.ok) {
        if (r.status === 401) return bubble('Please log in to use Ask AI.', 'ai');
        if (r.status === 429) return bubble('We\'ve hit the monthly AI limit. Please try next month.', 'ai');
        if (r.status === 503) return bubble('AI is temporarily offline. Please try again later.', 'ai');
        return bubble('Sorry—couldn\'t reach AI. Try again.', 'ai');
      }

      var payload = await r.json();
      bubble((payload && payload.answer) ? payload.answer : '(no answer)', 'ai');
    } catch (err) {
      thinking.stop();
      thinking.el.remove();
      bubble('Network error. Try again.', 'ai');
    }
  });
})();
</script>

</body>
</html>
